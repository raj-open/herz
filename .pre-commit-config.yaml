# ----------------------------------------------------------------
# Automates pre-commit actions,
# e.g. linting, tests, removal of artefacts, etc.
# ----------------------------------------------------------------
default_install_hook_types:
  - commit-msg
  - pre-commit
  - pre-push

fail_fast: true

repos:
  - repo: local
    hooks:

    - id: commit-message
      name: Commit Message
      description: |-
        This hook ensures that commit messages conform to the schema.
      # SIMPLER METHOD, but allows any branch name:
      language: pygrep
      args: [ '--negate' ]
      entry: '^(Merge remote-tracking branch .* into .*)$|^(\S+(-\S+)* > \S+(-\S+)*:\s+\S+(\s*\S+)*)$'
      verbose: true
      stages: [ commit-msg ]

  - repo: local
    hooks:

    - id: lint
      name: Lint files
      description: |-
        This hook performs linting on files.
      files: '^(src|tests|examples)/.*\.(py|ipynb)$'
      pass_filenames: true
      language: system
      args: []
      entry: |-
        bash -c '
          echo "Not implemented! Run manually."
          # just lint-check "$0" # perform linting without changes
          # just lint "$0" # perform linting with changes
          # git add "$0" # add to commit
        '
      verbose: true
      stages: [ pre-commit ]

    - id: utests
      name: Unit tests
      description: |-
        This hook performs checks to see if unit tests in this file are green.
      files: '^tests/unit(/tests_[^/]+)*/tests_[^/]+\.py$'
      pass_filenames: true
      language: system
      args: []
      entry: |-
        bash -c '
          echo "Not implemented! Run manually."
          # just test-unit "$0"
        '
      verbose: true
      stages: [ pre-commit ]

    - id: btests
      name: Behavioural tests
      description: |-
        This hook performs checks to see if behavioural tests in this file are green.
      files: '^tests/behave/features/.*\.feature$'
      pass_filenames: true
      language: system
      args: []
      entry: |-
        bash -c '
          # just run-api &        # run the api
          # export PID=$!         # store process id of api
          # just test-behave "$0" # run the test
          # kill $PID             # terminate the api
          echo "behavioural tests skipped - please run manually!";
        '
      verbose: true
      stages: [ pre-commit ]

  - repo: local
    hooks:

    - id: qa
      name: QA
      description: |-
        This hook performs QA on all files before a push.
      files: '.*'
      pass_filenames: false
      language: system
      args: []
      entry: |-
        bash -c '
          # run build
          just build-skip-requirements
          # run linting
          just lint "src"
          just lint "tests"
          # run unit tests
          just tests-unit
          # # run behavioural tests
          # just run-api &        # run the api
          # export PID=$!         # store process id of api
          # just test-behave "$0" # run the test
          # kill $PID             # terminate the api
          echo "behavioural tests in qa skipped - please run manually!";
        '
      verbose: true
      stages: [ pre-push ]
